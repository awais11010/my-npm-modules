/*
Copyright (c) 2020-present NAVER Corp.
name: mesh-simplifier
license: MIT
author: NAVER Corp.
repository: https://github.com/naver/mesh-simplifier
version: 1.0.0
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("three")):"function"==typeof define&&define.amd?define(["three"],e):(t=t||self).MeshSimplifier=e(t.THREE)}(this,function(p){"use strict";var t=function(){return(t=Object.assign||function(t){for(var e,r=1,n=arguments.length;r<n;r++)for(var i in e=arguments[r])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t}).apply(this,arguments)},w=function(){function r(t,e,r){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),this.x=t,this.y=e,this.z=r}var t=r.prototype;return r.addVectors=function(t,e){return(new r).copy(t).add(e)},r.subVectors=function(t,e){return(new r).copy(t).sub(e)},t.copy=function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},t.add=function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},t.sub=function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},t.dot=function(t){var e=this,r=e.x,n=e.y,i=e.z;return r*t.x+n*t.y+i*t.z},t.cross=function(t){var e=this,r=e.x,n=e.y,i=e.z,s=t.x,o=t.y,a=t.z;return this.x=n*a-i*o,this.y=i*s-r*a,this.z=r*o-n*s,this},t.normalize=function(){var t,e=this.length();return 0<e&&(t=1/e,this.x*=t,this.y*=t,this.z*=t),this},t.length=function(){var t=this.x,e=this.y,r=this.z;return Math.sqrt(t*t+e*e+r*r)},t.scaleSclar=function(t){return this.x*=t,this.y*=t,this.z*=t,this},r}(),n=function(){return function(t){this.originalIndex=t,this.v=[0,0,0],this.err=[0,0,0,0],this.deleted=!1,this.dirty=!1,this.n=new w}}(),m=function(){function i(t,e,r,n,i,s,o,a,c,u){void 0===t&&(t=0),void 0===e&&(e=0),void 0===r&&(r=0),void 0===n&&(n=0),void 0===i&&(i=0),void 0===s&&(s=0),void 0===o&&(o=0),void 0===a&&(a=0),void 0===c&&(c=0),void 0===u&&(u=0),this.m=new Array(10),this.set(t,e,r,n,i,s,o,a,c,u)}var t=i.prototype;return i.makePlane=function(t,e,r,n){return new i(t*t,t*e,t*r,t*n,e*e,e*r,e*n,r*r,r*n,n*n)},t.copy=function(t){var e=t.m;return this.m=e.concat(),this},t.set=function(t,e,r,n,i,s,o,a,c,u){var h=this.m;h[0]=t,h[1]=e,h[2]=r,h[3]=n,h[4]=i,h[5]=s,h[6]=o,h[7]=a,h[8]=c,h[9]=u},t.det=function(t,e,r,n,i,s,o,a,c){var u=this.m;return u[t]*u[i]*u[c]+u[r]*u[n]*u[a]+u[e]*u[s]*u[o]-u[r]*u[i]*u[o]-u[t]*u[s]*u[a]-u[e]*u[n]*u[c]},t.add=function(t){var e=this.m,r=t.m;return this.set(e[0]+r[0],e[1]+r[1],e[2]+r[2],e[3]+r[3],e[4]+r[4],e[5]+r[5],e[6]+r[6],e[7]+r[7],e[8]+r[8],e[9]+r[9]),this},i}(),i=function(){return function(t){this.originalIndex=t,this.p=new w,this.tstart=0,this.tcount=0,this.q=new m,this.border=!1}}(),s=function(){return function(){this.tid=0,this.tvertex=0}}(),o=function(){return function(t,e,r){this.a=t,this.b=e,this.c=r}}(),a=function(){function t(){this._diff=0,this._startTime=null}var e=t.prototype;return Object.defineProperty(e,"diff",{get:function(){return this._diff},enumerable:!0,configurable:!0}),e.start=function(){"undefined"!=typeof process&&process.hrtime?this._startTime=process.hrtime():this._startTime=Date.now()},e.end=function(){var t,e;null!=this._startTime&&("undefined"!=typeof process&&process.hrtime?(e=1e3*((t=process.hrtime(this._startTime))[0]+1e-9*t[1]),this._diff=e):this._diff=Date.now()-this._startTime,this._startTime=null)},t}(),e={__proto__:null,FastQuadric:function(){function t(t){var e=void 0===t?{}:t,r=e.targetPercentage,n=void 0===r?.5:r,i=e.aggressiveness,s=void 0===i?7:i;this._triangles=[],this._vertices=[],this._refs=[],this.targetPercentage=n,this.aggressiveness=s,this._timer=new a}var e=t.prototype;return Object.defineProperty(e,"timeConsumed",{get:function(){return this._timer.diff},enumerable:!0,configurable:!0}),e.simplify=function(t){var e=this,r=this._timer;return r.start(),t.geometries?t.geometries.forEach(function(t){e._process(t)}):this._process(t),r.end(),this},e._process=function(t){this._getData(t);var e=this._triangles,r=this._vertices,n=this._refs,i=this.targetPercentage,s=this.aggressiveness,o=this._triangles.length*i;e.forEach(function(t){return t.deleted=!1});for(var a=0,c=[],u=[],h=e.length,f=0;f<100&&!(h-a<=o);f++){f%5==0&&this._updateMesh(f),e.forEach(function(t){return t.dirty=!1});for(var l=1e-9*Math.pow(f+3,s),v=e.length-1;0<=v;v--){var p=e[v];if(!(p.err[3]>l||p.deleted||p.dirty)){for(var d=0;d<3;d++)if(p.err[d]<l){var m=p.v[d],_=p.v[(d+1)%3],y=r[m],g=r[_];if(y.border||g.border)continue;var x=new w;if(this._calculateError(m,_,x),c.splice(0),u.splice(0),this._flipped(x,_,y,c))continue;if(this._flipped(x,m,g,u))continue;y.p=x,y.q.add(g.q);var b=n.length;a+=this._updateTriangles(m,y,c),a+=this._updateTriangles(m,g,u);var M=n.length-b;y.tstart=b,y.tcount=M;break}if(h-a<=o)break}}}this._compactMesh(),this._setData(t)},e._getData=function(t){var e=t.prepare();this._vertices=e.vertices.map(function(t,e){var r=new i(e);return r.p.copy(t),r}),this._triangles=e.faces.map(function(t,e){var r=new n(e);return r.v=[t.a,t.b,t.c],r}),this._refs=[]},e._setData=function(t){var e=this._triangles,r=this._vertices.map(function(t){return t.p}),n=e.map(function(t){var e=t.v;return new o(e[0],e[1],e[2])}),i=this._vertices.map(function(t){return t.originalIndex}),s=this._triangles.map(function(t){return t.originalIndex});t.update({vertices:r,faces:n,unculledVertices:i,unculledFaces:s})},e._flipped=function(t,e,r,n){for(var i=this._triangles,s=this._vertices,o=this._refs,a=0;a<r.tcount;a++){var c=o[r.tstart+a],u=i[c.tid];if(!u.deleted){var h=c.tvertex,f=u.v[(h+1)%3],l=u.v[(h+2)%3];if(f!==e&&l!==e){var v=w.subVectors(s[f].p,t),p=w.subVectors(s[l].p,t);if(v.normalize(),p.normalize(),.999<Math.abs(v.dot(p)))return!0;var d=(new w).copy(v).cross(p);if(d.normalize(),n[a]=!1,d.dot(u.n)<.2)return!0}else n[a]=!0}}return!1},e._updateTriangles=function(t,e,r){for(var n=this._triangles,i=this._refs,s=new w,o=0,a=0;a<e.tcount;a++){var c=i[e.tstart+a],u=n[c.tid];u.deleted||(r[a]?(u.deleted=!0,o++):(u.v[c.tvertex]=t,u.dirty=!0,u.err[0]=this._calculateError(u.v[0],u.v[1],s),u.err[1]=this._calculateError(u.v[1],u.v[2],s),u.err[2]=this._calculateError(u.v[2],u.v[0],s),u.err[3]=Math.min(u.err[0],u.err[1],u.err[2]),i.push(c)))}return o},e._updateMesh=function(t){var i=this,u=this._vertices,h=this._refs;0<t?this._triangles=this._triangles.filter(function(t){return!t.deleted}):(u.forEach(function(t){return t.q=new m}),this._triangles.forEach(function(t){var e=t.v.map(function(t){return u[t].p}),r=w.subVectors(e[1],e[0]).cross(w.subVectors(e[2],e[0])).normalize();t.n=r;var n=m.makePlane(r.x,r.y,r.z,-r.dot(e[0]));t.v.forEach(function(t){return u[t].q.add(n)})}),this._triangles.forEach(function(r){var n=new w;r.v.forEach(function(t,e){r.err[e]=i._calculateError(t,r.v[(e+1)%3],n)})})),u.forEach(function(t){t.tstart=0,t.tcount=0});var f=this._triangles;f.forEach(function(t){t.v.forEach(function(t){return u[t].tcount++})});var e=0;u.forEach(function(t){t.tstart=e,e+=t.tcount,t.tcount=0});for(var r=h.length;r<3*f.length;r++)h[r]=new s;f.forEach(function(t,e){for(var r=0;r<3;r++){var n=u[t.v[r]];h[n.tstart+n.tcount].tid=e,h[n.tstart+n.tcount].tvertex=r,n.tcount++}}),0===t&&(u.forEach(function(t){return t.border=!1}),u.forEach(function(t){for(var e=[],r=[],n=0;n<t.tcount;n++)for(var i=h[t.tstart+n].tid,s=f[i],o=0;o<3;o++){for(var a=s.v[o],c=0;c<e.length&&r[c]!==a;)c++;c===e.length?(e.push(1),r.push(a)):e[c]++}for(o=0;o<e.length;o++)1===e[o]&&(u[r[o]].border=!0)}))},e._calculateError=function(t,e,r){var n,i,s,o,a,c,u=this._vertices,h=u[t],f=u[e],l=(new m).copy(h.q).add(f.q),v=h.border&&f.border,p=l.det(0,1,2,1,4,5,2,5,7),d=0;return 0===p||v?(n=h.p,i=f.p,s=new w(.5*(n.x+i.x),.5*(n.y+i.y),.5*(n.z+i.z)),o=this._vertexError(l,n),a=this._vertexError(l,i),c=this._vertexError(l,s),o===(d=Math.min(o,a,c))&&r.copy(n),a===d&&r.copy(i),c===d&&r.copy(s)):(r.x=-1/p*l.det(1,2,3,4,5,6,5,7,8),r.y=1/p*l.det(0,2,3,1,5,6,2,7,8),r.z=-1/p*l.det(0,1,3,1,4,6,2,5,8),d=this._vertexError(l,r)),d},e._vertexError=function(t,e){var r=e.x,n=e.y,i=e.z,s=t.m;return s[0]*r*r+2*s[1]*r*n+2*s[2]*r*i+2*s[3]*r+s[4]*n*n+2*s[5]*n*i+2*s[6]*n+s[7]*i*i+2*s[8]*i+s[9]},e._compactMesh=function(){this._triangles=this._triangles.filter(function(t){return!t.deleted});var t=this._triangles,n=this._vertices;n.forEach(function(t){return t.tcount=0}),t.forEach(function(t){t.v.forEach(function(t){n[t].tcount=1})});var e=0;n.forEach(function(t){0<t.tcount&&(t.tstart=e,n[e].originalIndex=t.originalIndex,n[e].p=t.p,e++)}),t.forEach(function(r){r.v.forEach(function(t,e){r.v[e]=n[t].tstart})}),n.splice(e)},t}()},r={__proto__:null,Vector3:w,Face3:o,SymmetricMatrix:m},c=function(){function t(t){this._isBufferGeometry=t.isBufferGeometry,this.originalGeometry=t,this._isBufferGeometry?this._processingGeometry=(new p.Geometry).fromBufferGeometry(t):this._processingGeometry=this.originalGeometry}var e=t.prototype;return e.prepare=function(){var t=this._processingGeometry;return t.mergeVertices(),{vertices:t.vertices.map(function(t){return new w(t.x,t.y,t.z)}),faces:t.faces.map(function(t){return new o(t.a,t.b,t.c)})}},e.update=function(t){var e,r,n,i,f,s=t.vertices,o=t.faces,a=(t.unculledVertices,t.unculledFaces),l=this._processingGeometry,v=l.faceVertexUvs,c=v[0]&&0<v[0].length,u=v[1]&&0<v[1].length;return l.vertices=s.map(function(t){return new p.Vector3(t.x,t.y,t.z)}),l.faces=o.map(function(t){return new p.Face3(t.a,t.b,t.c)}),c&&(l.faceVertexUvs[0]=a.map(function(t){return l.faceVertexUvs[0][t]})),u&&(l.faceVertexUvs[1]=a.map(function(t){return l.faceVertexUvs[1][t]})),l.computeFaceNormals(),this._isBufferGeometry?(e=this.originalGeometry,r=(new p.BufferGeometry).fromGeometry(l),n=e.attributes.color&&0<e.attributes.color.count,i=e.attributes.tangent&&0<e.attributes.tangent.count,n||r.deleteAttribute("color"),i&&c&&(f=new Float32Array(12*o.length),o.forEach(function(t,e){var r=[t.a,t.b,t.c].map(function(t){return l.vertices[t]}),n=v[0][e],i=(new p.Vector3).subVectors(r[1],r[0]),s=(new p.Vector3).subVectors(r[2],r[0]),o=(new p.Vector2).subVectors(n[1],n[0]),a=(new p.Vector2).subVectors(n[2],n[0]),c=1/(o.x*a.y-o.y*a.x),u=i.multiplyScalar(a.y).sub(s.multiplyScalar(o.y)).multiplyScalar(c).normalize(),h=12*e;[0,1,2].forEach(function(t){var e=h+4*t;f[e]=u.x,f[1+e]=u.y,f[2+e]=u.z,f[3+e]=1})}),r.setAttribute("tangent",new p.BufferAttribute(f,4))),e.copy(r)):(l.verticesNeedUpdate=!0,l.elementsNeedUpdate=!0,l.uvsNeedUpdate=!0),this},t}(),u={__proto__:null,ThreeGeometry:c},h=["alphaMap","aoMap","bumpMap","displacementMap","emissiveMap","envMap","lightMap","map","metalnessMap","normalMap"],f={__proto__:null,ThreeAdapter:function(){function t(t,e){void 0===e&&(e=!1),this.object=e?t.clone():t,e&&this._cloneMeshes(t)}var e=t.prototype;return Object.defineProperty(e,"geometries",{get:function(){var r=[];return this.object.traverse(function(t){var e;t.isMesh&&(e=new c(t.geometry),r.push(e))}),r},enumerable:!0,configurable:!0}),e._cloneMeshes=function(t){var n=this,i=[],e=[];t.traverse(function(t){t.isMesh&&i.push(t)}),this.object.traverse(function(t){t.isMesh&&e.push(t)}),e.forEach(function(t,e){var r=i[e];t.geometry=t.geometry.clone(),t.material=Array.isArray(t.material)?t.material.map(function(t){return n._cloneMaterial(t)}):n._cloneMaterial(t.material),t.isSkinnedMesh&&n._skinnedMeshToMesh(t,r.skeleton)})},e._cloneMaterial=function(t){var e=t.clone();if("MeshStandardMaterial"===t.type){var r=t;h.forEach(function(t){var e;null!=r[t]&&(e=r[t],r[t]=r[t].clone(),r[t].needsUpdate=!0,"metalnessMap"===t&&e===r.roughnessMap&&(r.roughnessMap=r.metalnessMap))})}else for(var n in e)e[n]&&e[n].isTexture&&(e[n]=e[n].clone(),e[n].needsUpdate=!0);return e.needsUpdate=!0,e},e._skinnedMeshToMesh=function(o,t){var e=o.geometry,a=e.attributes.position,c=e.attributes.skinIndex,u=e.attributes.skinWeight;o.updateMatrixWorld(),t.update();for(var h=t.boneMatrices,f=new p.Matrix4,r=function(t){f.identity();var n=new p.Vector4;n.set(0,0,0,0);var i=new p.Vector4;i.set(a.getX(t),a.getY(t),a.getZ(t),1).applyMatrix4(o.bindMatrix);var e=[u.getX(t),u.getY(t),u.getZ(t),u.getW(t)],s=[c.getX(t),c.getY(t),c.getZ(t),c.getW(t)];e.forEach(function(t,e){var r=(new p.Matrix4).fromArray(h,16*s[e]).multiplyScalar(t);n.add(i.clone().applyMatrix4(r))});var r=n.applyMatrix4(o.bindMatrixInverse);a.setXYZ(t,r.x,r.y,r.z)},n=0;n<a.count;n++)r(n);var i=o.parent,s=new p.Mesh(o.geometry,o.material).copy(o);s.geometry.deleteAttribute("skinIndex"),s.geometry.deleteAttribute("skinWeight"),i.remove(o),i.add(s)},t}()};return t(t(t(t({},e),r),u),f)});
//# sourceMappingURL=mesh-simplifier.min.js.map
